<!DOCTYPE html>
<html>
    <head lang="en">
        <meta charset="UTF-8">
        <title></title>
        <link type="stylesheet" href="/betterform/bfResources/scripts/x-tag-bundle/x-tag-components.min.css"/>
    </head>
    <body>
        <h1>Atmosphere Test Page</h1>

        <better-atmosphere></better-atmosphere>


        <script src="/betterform/webcomponents/bower_components/x-tag-core/dist/x-tag-core.js" type="text/javascript"></script>
        <script src="/betterform/webcomponents/bower_components/jquery/dist/jquery.js" type="text/javascript"></script>
        <script src="/betterform/webcomponents/bower_components/jquery-atmosphere/jquery.atmosphere.js" type="text/javascript"></script>
        <!--<script src="/betterform/webcomponents/better-atmosphere.js" type="text/javascript"></script>-->


        <script type="text/javascript">

            $(function() {
                xtag.register('better-atmosphere', {


                    lifecycle: {


                        created: function () {
                            console.log("better-atmosphere created", this);
                            this.socket = $.atmosphere;

                            this.request = {
                                url: '/betterform/msg',
                                contentType: "application/json",
                                logLevel: 'debug',
                                transport: 'sse',
                                fallbackTransport: 'long-polling',

                                onOpen: function (response) {
                                    console.log('Atmosphere connected using ' + response.transport);
                                },

                                onMessage: function (response) {
                                    var message = response.responseBody;
                                    try {
                                        var json = jQuery.parseJSON(message);
                                    } catch (e) {
                                        console.log('This doesn\'t look like a valid JSON: ', message);
                                        return;
                                    }
                                    console.log("json: ", json);
                                },
                                onClose: function (response) {
                                    console.log("onCl ose called");
                                }

                            };

                            this.subSocket = this.socket.subscribe(this.request);
                        },
                        inserted: function () {
                            console.log("better-atmosphere inserted");
                        },
                        removed: function () {
                            console.log("better-atmosp here removed");
                        },
                        attributeChanged: function () {
                            console.log("better-atmosphere attributeChanged  ");
                        }
                    },
                    events: {
                    },
                    accessors: {

                    },
                    methods: {
                        pushMsg: function (msg) {
                            console.log("pushing: ",msg);
                            this.subSocket.push(jQuery.stringifyJSON(msg));
                        }
                    }
                });
            });
        </script>
    </body>
</html>